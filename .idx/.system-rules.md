SYSTEM INSTRUCTIONS: Senior Web Development Protocol
1. General Rules (Stability and Minimal Scope)
Criticality: Treat every change as critical. Limit the scope to the absolute minimum required by the task.

Isolation: Do not modify unrelated components, configuration, or dependencies without explicit necessity.

Verification: Every change must pass: lint, typecheck, build, and local dev runtime validation.

Git Diff: Always provide a clear Git Diff or full file structure that allows for easy reversion.

2. Project Structure and Responsibilities
Business Logic:

src/lib/actions.ts – Server Actions/handlers.

src/lib/firebase-admin.ts – Firebase Admin SDK (Server-side privileged operations).

src/lib/firebase.ts – Firebase Client SDK (Real-time listeners/Client-side updates).

UI:

General Components: src/components/ui

Functional Components: src/components

Global State:

src/components/main-layout.tsx – MainLayoutContext (providing data from Firebase and operations like handleUpdateSettings).

3. Import Standards
Absolute Aliases (Preferred): e.g., import { db } from '@/lib/firebase'.

Relative (Local): Only for imports from the same folder or close proximity (max 1–2 levels ../).

Strictness: Never use long chains like ../../../../.

4. AI Operating Rules
Minimal Scope: Do not touch files outside the task scope.

Full Files: Return entire final content in the XML format described in Section 5.

Client/Server Boundary: Do not import firebase-admin in client components ("use client").

Data Safety: When parsing Excel/CSV locally (SheetJS), ensure data is validated via Zod before pushing to Firebase. Use Web Workers for large files to avoid UI freezes.

5. AI Output Contract (XML)
Every proposed file change MUST be returned in the XML format below:

XML

<changes>
  <description>[Brief description of the changes]</description>
  <change>
    <file>[ABSOLUTE PATH, e.g., /src/lib/firebase.ts]</file>
    <content><![CDATA[
[FULL, FINAL FILE CONTENT HERE]
]]></content>
  </change>
</changes>
8. Firebase Realtime Database Integration (Security and Reliability)
Authentication & Authorization:

Use Firebase Auth for user identification.

Security Rules: Database Security Rules must enforce that users can only read/write their own data or specific paths based on roles.

Server vs. Client:

Use firebase-admin in Server Actions/API routes for privileged operations (e.g., bulk imports, administrative tasks).

Use firebase/database (Client SDK) for real-time UI updates and reactive state.

Data Validation:

Validate all data with Zod schemas before writing to Firebase.

Check for malicious content (e.g., script injection) even for data being stored locally or in the RTDB.

Connectivity: * Handle offline states gracefully using Firebase's built-in caching.

Ensure listeners are properly detached (off()) in useEffect cleanup to prevent memory leaks.

12. Checklists
Before Sending a PR

[ ] Changes are limited to the required files.

[ ] Code passes npm run lint, npm run typecheck.

[ ] No firebase-admin imports in client code.

[ ] Firebase Security Rules have been considered for the new data paths.

[ ] Data validation (Zod) is applied to all database writes.

Before Deployment

[ ] Environment variables for Firebase (API Keys, Project ID) are set.

[ ] Private keys for the Service Account are not in NEXT_PUBLIC_*.

[ ] Real-time listeners have cleanup functions.

14. Date Handling Standard (and Excel/CSV Export)
Storage: Dates should be stored in Firebase as ISO 8601 strings or Unix Timestamps for easy querying/sorting.

Formatting: Use @/lib/date.ts (wrapping date-fns) for all UI display.

Import/Export: When importing from Excel/CSV (SheetJS), use parseMaybeDate to validate before sending to Firebase. Avoid UI freezes by using asynchronous processing for large datasets.

15. Empty/Nullable Field Handling Rules
NoSQL Flexibility: In Firebase, if a field is empty, prefer removing the key entirely or setting it to null.

Zod Integration: Use .nullable() or .optional() in schemas to match Firebase’s schema-less nature.

UI Fallbacks: Render missing Firebase nodes as "—" or "N/A" consistently.